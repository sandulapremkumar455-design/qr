{% extends "base.html" %}
{% block title %}Admin Dashboard — Smart Attendance System{% endblock %}
{% block page_title %}
  <span class="live-dot" style="font-family:'Syne',sans-serif;font-weight:700;">Dashboard</span>
{% endblock %}
{% block topbar_actions %}
  <span class="badge badge-accent font-mono" style="font-size:10px;">
    <i class="fas fa-clock"></i> <span id="live-time"></span>
  </span>
{% endblock %}

{% block head %}
<style>
.dash-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-top:20px}
.chart-wrap{position:relative;height:200px}
.session-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.session-row:last-child{border-bottom:none}
.session-subject{font-family:'Syne',sans-serif;font-weight:600;font-size:13px;text-transform:capitalize}
.session-meta{font-size:11px;color:var(--text3);font-family:'Space Mono',monospace;margin-top:2px}
.active-indicator{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.active-indicator.live{background:var(--teal);box-shadow:0 0 8px rgba(0,212,170,0.6);animation:pulse 2s infinite}
.active-indicator.ended{background:var(--text3)}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.qa-btn{padding:18px;background:var(--panel2);border:1px solid var(--border);border-radius:var(--r-lg);text-align:center;text-decoration:none;color:var(--text);transition:all 0.25s;cursor:pointer;display:block}
.qa-btn:hover{transform:translateY(-3px);border-color:var(--accent);box-shadow:var(--glow-accent)}
.qa-btn i{font-size:22px;display:block;margin-bottom:8px}
.qa-btn span{font-family:'Syne',sans-serif;font-size:12px;font-weight:600}
.filter-pill-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:0}
.filter-pill{padding:6px 14px;border-radius:20px;background:var(--panel2);border:1px solid var(--border);font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;transition:all 0.2s;color:var(--text2)}
.filter-pill.active,.filter-pill:hover{background:rgba(108,99,255,0.15);border-color:var(--accent);color:var(--accent-h)}
.batch-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;margin-bottom:24px}
.batch-card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px 18px;transition:all 0.25s;position:relative;overflow:hidden}
.batch-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.batch-card.good::before{background:linear-gradient(90deg,var(--teal),transparent)}
.batch-card.warn::before{background:linear-gradient(90deg,var(--amber),transparent)}
.batch-card.danger::before{background:linear-gradient(90deg,var(--red),transparent)}
.batch-card:hover{border-color:var(--border3);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.batch-title{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;margin-bottom:10px}
.batch-pct{font-family:'Bebas Neue',sans-serif;font-size:36px;line-height:1}
.batch-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);margin-top:2px}
.batch-alert{display:inline-flex;align-items:center;gap:4px;margin-top:8px;padding:3px 8px;border-radius:12px;font-family:'Space Mono',monospace;font-size:10px}
@media(max-width:1100px){.dash-grid{grid-template-columns:1fr}}
@media(max-width:640px){.batch-grid{grid-template-columns:1fr 1fr}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

<!-- STAT CARDS -->
<div class="stat-grid stagger">
  <div class="stat-card accent">
    <div class="stat-icon accent"><i class="fas fa-users"></i></div>
    <div class="stat-value gradient-text" id="stat-students">{{ total_students }}</div>
    <div class="stat-label">TOTAL STUDENTS</div>
  </div>
  <div class="stat-card teal">
    <div class="stat-icon teal"><i class="fas fa-chalkboard-teacher"></i></div>
    <div class="stat-value" style="color:var(--teal)" id="stat-sessions">{{ total_sessions }}</div>
    <div class="stat-label">SESSIONS CONDUCTED</div>
  </div>
  <div class="stat-card amber">
    <div class="stat-icon amber"><i class="fas fa-list-check"></i></div>
    <div class="stat-value" style="color:var(--amber)" id="stat-att">{{ total_att }}</div>
    <div class="stat-label">ATTENDANCE RECORDS</div>
  </div>
  <div class="stat-card {% if active_sessions > 0 %}teal{% else %}danger{% endif %}">
    <div class="stat-icon {% if active_sessions > 0 %}teal{% else %}danger{% endif %}">
      <i class="fas fa-{% if active_sessions > 0 %}broadcast-tower{% else %}circle-xmark{% endif %}"></i>
    </div>
    <div class="stat-value" style="color:var(--{% if active_sessions > 0 %}teal{% else %}red{% endif %})" id="stat-active">{{ active_sessions }}</div>
    <div class="stat-label">ACTIVE SESSIONS</div>
  </div>
  <div class="stat-card {% if total_below75 > 0 %}danger{% else %}teal{% endif %}">
    <div class="stat-icon {% if total_below75 > 0 %}danger{% else %}teal{% endif %}">
      <i class="fas fa-triangle-exclamation"></i>
    </div>
    <div class="stat-value" style="color:var(--{% if total_below75 > 0 %}red{% else %}teal{% endif %})">{{ total_below75 }}</div>
    <div class="stat-label">STUDENTS BELOW 75%</div>
  </div>
  <div class="stat-card {% if suspicious_today > 0 %}danger{% else %}accent{% endif %}">
    <div class="stat-icon {% if suspicious_today > 0 %}danger{% else %}accent{% endif %}">
      <i class="fas fa-shield-exclamation"></i>
    </div>
    <div class="stat-value" style="color:var(--{% if suspicious_today > 0 %}red{% else %}accent-h{% endif %})">{{ suspicious_today }}</div>
    <div class="stat-label">SUSPICIOUS TODAY</div>
  </div>
</div>

<!-- BATCH ANALYTICS -->
{% if batch_analytics %}
<div style="margin:20px 0 10px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
  <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:2px;">BATCH PERFORMANCE</div>
  <div class="filter-pill-row">
    <div class="filter-pill active" onclick="filterStats('','')">ALL</div>
    <div class="filter-pill" onclick="filterStats('1st Year','CS')">1ST CS</div>
    <div class="filter-pill" onclick="filterStats('2nd Year','CS')">2ND CS</div>
    <div class="filter-pill" onclick="filterStats('3rd Year','CS')">3RD CS</div>
    <div class="filter-pill" onclick="filterStats('1st Year','IT')">1ST IT</div>
    <div class="filter-pill" onclick="filterStats('2nd Year','IT')">2ND IT</div>
  </div>
</div>
<div class="batch-grid">
  {% for b in batch_analytics %}
  {% set cls = 'good' if b.avg_pct >= 75 else ('warn' if b.avg_pct >= 60 else 'danger') %}
  <a href="{{ url_for('student_info', year=b.year, branch=b.branch) }}" style="text-decoration:none;">
    <div class="batch-card {{ cls }}">
      <div class="batch-title">{{ b.year }} · {{ b.branch }}</div>
      <div class="batch-pct" style="color:{% if b.avg_pct >= 75 %}var(--teal){% elif b.avg_pct >= 60 %}var(--amber){% else %}var(--red){% endif %}">{{ b.avg_pct }}%</div>
      <div class="batch-sub">{{ b.sessions }} sessions · {{ b.students }} students</div>
      {% if b.below75 > 0 %}
      <div class="batch-alert" style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);color:var(--red);">
        <i class="fas fa-triangle-exclamation"></i> {{ b.below75 }} below 75%
      </div>
      {% else %}
      <div class="batch-alert" style="background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);color:var(--teal);">
        <i class="fas fa-circle-check"></i> All on track
      </div>
      {% endif %}
    </div>
  </a>
  {% endfor %}
</div>
{% endif %}

<!-- MAIN GRID -->
<div class="dash-grid">
  <!-- LEFT -->
  <div style="display:flex;flex-direction:column;gap:20px;">

    <div class="card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-chart-bar" style="color:var(--accent);margin-right:8px"></i>Attendance Last 7 Days</div>
      </div>
      <div class="card-body"><div class="chart-wrap"><canvas id="attendanceChart"></canvas></div></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-clock-rotate-left" style="color:var(--teal);margin-right:8px"></i>Recent Sessions</div>
        <a href="{{ url_for('attendance_dashboard') }}" class="btn btn-ghost btn-sm">View All</a>
      </div>
      <div class="card-body" style="padding-top:8px;padding-bottom:8px;">
        {% for sess in recent %}
        <div class="session-row">
          <div class="active-indicator {% if sess.is_active and not sess.is_expired() %}live{% else %}ended{% endif %}"></div>
          <div style="flex:1;min-width:0;">
            <div class="session-subject">{{ sess.subject.name.title() }}</div>
            <div class="session-meta">
              {{ sess.year }} · {{ sess.branch }} · {{ sess.created_at.strftime('%d %b, %I:%M %p') }}
              · <span style="color:var(--accent-h)">{{ sess.created_by.name }}</span>
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--teal);">{{ sess.attendances.count() }}</div>
            <div style="font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;">PRESENT</div>
          </div>
          {% if sess.is_active and not sess.is_expired() %}
            <a href="{{ url_for('session_live', session_id=sess.id) }}" class="btn btn-teal btn-sm"><i class="fas fa-eye"></i></a>
          {% endif %}
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-chalkboard"></i>
          <p>No sessions yet. <a href="{{ url_for('start_class') }}" style="color:var(--accent-h)">Start one!</a></p>
        </div>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- RIGHT -->
  <div style="display:flex;flex-direction:column;gap:20px;">

    <div class="card">
      <div class="card-header"><div class="card-title">Quick Actions</div></div>
      <div class="card-body">
        <div class="quick-actions">
          <a href="{{ url_for('start_class') }}" class="qa-btn">
            <i class="fas fa-play-circle" style="color:var(--teal)"></i><span>Start Class</span>
          </a>
          <a href="{{ url_for('recent_class') }}" class="qa-btn">
            <i class="fas fa-clock-rotate-left" style="color:var(--accent-h)"></i><span>Recent Class</span>
          </a>
          <a href="{{ url_for('student_info') }}" class="qa-btn">
            <i class="fas fa-users" style="color:var(--amber)"></i><span>Students</span>
          </a>
          <a href="{{ url_for('suspicious_panel') }}" class="qa-btn">
            <i class="fas fa-shield-exclamation" style="color:var(--red)"></i><span>Security</span>
          </a>
          <a href="{{ url_for('admin_subjects') }}" class="qa-btn">
            <i class="fas fa-book-open" style="color:var(--teal)"></i><span>Subjects</span>
          </a>
          <a href="{{ url_for('export_csv') }}" class="qa-btn">
            <i class="fas fa-file-csv" style="color:var(--text2)"></i><span>Export CSV</span>
          </a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title"><span class="live-dot">Live Now</span></div></div>
      <div class="card-body">
        {% set active_list = recent | selectattr('is_active') | list %}
        {% set has_live = [] %}
        {% for sess in active_list %}{% if not sess.is_expired() %}{% set _ = has_live.append(1) %}{% endif %}{% endfor %}
        {% if has_live %}
          {% for sess in active_list %}{% if not sess.is_expired() %}
          <div style="padding:14px;background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.2);border-radius:var(--r-md);margin-bottom:10px;">
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;margin-bottom:4px;text-transform:capitalize;">
              {{ sess.subject.name }} — {{ sess.branch }} {{ sess.year }}
            </div>
            <div style="font-size:11px;color:var(--text3);font-family:'Space Mono',monospace;margin-bottom:8px;">by {{ sess.created_by.name }}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);">{{ sess.attendances.count() }} present</span>
              <a href="{{ url_for('session_live', session_id=sess.id) }}" class="btn btn-teal btn-sm"><i class="fas fa-eye"></i> Monitor</a>
            </div>
          </div>
          {% endif %}{% endfor %}
        {% else %}
          <div class="empty-state" style="padding:30px 20px;"><i class="fas fa-moon"></i><p>No live sessions</p></div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">Export Data</div></div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:10px;">
        <a href="{{ url_for('export_csv') }}" class="btn btn-ghost btn-full">
          <i class="fas fa-file-csv" style="color:var(--teal)"></i> Full Export CSV
        </a>
        <a href="{{ url_for('attendance_dashboard') }}" class="btn btn-ghost btn-full">
          <i class="fas fa-filter" style="color:var(--accent-h)"></i> Filtered Export
        </a>
      </div>
    </div>

  </div>
</div>

<script>
function tick(){const el=document.getElementById('live-time');if(el)el.textContent=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
tick();setInterval(tick,1000);
const chartData={{ chart_data|safe }};
const ctx=document.getElementById('attendanceChart').getContext('2d');
const gradient=ctx.createLinearGradient(0,0,0,200);
gradient.addColorStop(0,'rgba(108,99,255,0.4)');gradient.addColorStop(1,'rgba(108,99,255,0.02)');
new Chart(ctx,{type:'bar',data:{labels:chartData.map(d=>d.day),datasets:[{label:'Attendance',data:chartData.map(d=>d.count),backgroundColor:gradient,borderColor:'rgba(108,99,255,0.8)',borderWidth:2,borderRadius:6,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(20,20,30,0.95)',borderColor:'rgba(108,99,255,0.4)',borderWidth:1,titleColor:'#e4e4f0',bodyColor:'#9090b0',padding:10,cornerRadius:8}},scales:{x:{grid:{color:'rgba(30,30,48,0.5)'},ticks:{color:'#50506a',font:{family:'Space Mono',size:10}}},y:{grid:{color:'rgba(30,30,48,0.5)'},ticks:{color:'#50506a',font:{family:'Space Mono',size:10},stepSize:1},beginAtZero:true}}}});
function filterStats(year,branch){document.querySelectorAll('.filter-pill').forEach(p=>p.classList.remove('active'));event.target.classList.add('active');fetch(`/api/admin/stats?year=${encodeURIComponent(year)}&branch=${encodeURIComponent(branch)}`).then(r=>r.json()).then(d=>{document.getElementById('stat-students').textContent=d.total_students;document.getElementById('stat-sessions').textContent=d.total_sessions;document.getElementById('stat-att').textContent=d.total_att;document.getElementById('stat-active').textContent=d.active_sessions;});}
setInterval(()=>{fetch('/api/admin/stats?year=&branch=').then(r=>r.json()).then(d=>{document.getElementById('stat-active').textContent=d.active_sessions;});},10000);
</script>
{% endblock %}
