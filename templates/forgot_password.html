{% extends "base.html" %}
{% block title %}Forgot Password ‚Äî Smart Attendance System{% endblock %}

{% block auth_content %}
<style>
.fp-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative}
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:48px 48px;opacity:0.2;pointer-events:none;mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black 20%,transparent 80%)}
.fp-box{width:100%;max-width:440px;background:var(--panel);border:1px solid var(--border2);border-radius:var(--r-xl);padding:40px;box-shadow:var(--shadow-lg);animation:slideUp 0.5s cubic-bezier(0.4,0,0.2,1)}
.steps-bar{display:flex;gap:0;margin-bottom:28px;border-radius:var(--r-md);overflow:hidden;border:1px solid var(--border)}
.step-item{flex:1;padding:9px 6px;text-align:center;font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--text3);background:var(--bg3);transition:all 0.3s;border-right:1px solid var(--border)}
.step-item:last-child{border-right:none}
.step-item.active{background:rgba(108,99,255,0.15);color:var(--accent-h)}
.step-item.done{background:rgba(0,212,170,0.1);color:var(--teal)}
.mode-toggle{display:inline-flex;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-md);padding:4px;gap:4px;margin-bottom:14px}
.mode-btn{padding:7px 16px;border:none;border-radius:var(--r-sm);font-family:'Syne',sans-serif;font-weight:600;font-size:12px;cursor:pointer;color:var(--text2);background:none;transition:all 0.2s}
.mode-btn.active{background:var(--accent);color:#fff}
.face-ring{position:relative;width:180px;height:180px;margin:0 auto 10px;border-radius:50%;background:#000;overflow:hidden;border:3px solid var(--border2);transition:border-color 0.3s}
.face-ring.scanning{border-color:var(--accent);animation:facePulse 1.5s ease-in-out infinite}
.face-ring.ok{border-color:var(--teal);box-shadow:0 0 0 8px rgba(0,212,170,0.15)}
.face-ring.fail{border-color:var(--red);box-shadow:0 0 0 8px rgba(255,107,107,0.15)}
@keyframes facePulse{0%,100%{box-shadow:0 0 0 0 rgba(108,99,255,0.5)}50%{box-shadow:0 0 0 14px rgba(108,99,255,0)}}
#fp-video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
.face-overlay{position:absolute;inset:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:44px;opacity:0;transition:opacity 0.3s;background:rgba(0,0,0,0.4)}
.face-overlay.show{opacity:1}
.upload-circle{width:180px;height:180px;border-radius:50%;border:3px dashed var(--border2);background:var(--bg3);margin:0 auto 10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.25s;overflow:hidden;position:relative}
.upload-circle:hover,.upload-circle.ready{border-color:var(--accent);background:rgba(108,99,255,0.05);border-style:solid}
.upload-circle.ok{border-color:var(--teal);border-style:solid}
.upload-circle.fail{border-color:var(--red);border-style:solid}
#fp-up-img{width:100%;height:100%;object-fit:cover;display:none;position:absolute;inset:0}
.uc-ph{display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--text3);text-align:center;padding:10px;pointer-events:none}
.f-st{font-family:'Space Mono',monospace;font-size:11px;color:var(--text2);margin-bottom:14px;text-align:center;min-height:16px}
</style>

<script>
(function(){
  var s=document.createElement("script");
  s.src="/static/face-api.min.js";
  s.onerror=function(){var fb=document.createElement("script");fb.src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js";document.head.appendChild(fb);};
  document.head.appendChild(s);
})();
</script>
<canvas id="fp-canvas" style="display:none"></canvas>

<div class="grid-bg"></div>
<div class="fp-wrap">
  <div class="fp-box">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:22px;margin-bottom:4px">
        <i class="fas fa-key" style="color:var(--accent)"></i> Reset Password
      </div>
      <div style="font-size:13px;color:var(--text2)">Verify your identity to reset</div>
    </div>

    <div class="steps-bar">
      <div class="step-item active" id="slbl-1">1 ¬∑ PIN</div>
      <div class="step-item" id="slbl-2">2 ¬∑ FACE</div>
      <div class="step-item" id="slbl-3">3 ¬∑ NEW PW</div>
    </div>

    <!-- STEP 1 -->
    <div id="step1">
      <div class="form-group">
        <label class="form-label">YOUR PIN / ROLL NUMBER</label>
        <div style="position:relative">
          <i class="fas fa-id-badge" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)"></i>
          <input type="text" id="fp-pin" class="form-control" style="padding-left:40px" placeholder="Enter your PIN"
                 onkeydown="if(event.key==='Enter')verifyPin()"/>
        </div>
      </div>
      <button class="btn btn-primary btn-full btn-lg" onclick="verifyPin()">
        <i class="fas fa-arrow-right"></i> Continue
      </button>
      <div style="text-align:center;margin-top:16px">
        <a href="{{ url_for('login') }}" style="color:var(--text3);font-size:13px;text-decoration:none">
          <i class="fas fa-arrow-left"></i> Back to Login
        </a>
      </div>
    </div>

    <!-- STEP 2: Face -->
    <div id="step2" style="display:none;text-align:center">
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px">Prove it's you ‚Äî camera or photo upload</div>

      <div class="mode-toggle">
        <button class="mode-btn active" id="fp-btn-cam" onclick="fpSwitch('camera')">
          <i class="fas fa-camera"></i> Camera
        </button>
        <button class="mode-btn" id="fp-btn-up" onclick="fpSwitch('upload')">
          <i class="fas fa-image"></i> Upload Photo
        </button>
      </div>

      <!-- Camera -->
      <div id="fp-cam-view">
        <div class="face-ring" id="fp-face-ring">
          <video id="fp-video" autoplay muted playsinline></video>
          <div class="face-overlay" id="fp-overlay"></div>
        </div>
        <div class="f-st" id="fp-cam-st">Loading AI models...</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn btn-primary" id="fp-scan-btn" onclick="fpScan()" disabled>
            <i class="fas fa-camera"></i> Verify Face
          </button>
          <button class="btn btn-ghost btn-sm" onclick="fpBack1()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <!-- Upload -->
      <div id="fp-up-view" style="display:none">
        <div class="upload-circle" id="fp-up-zone" onclick="document.getElementById('fp-file').click()">
          <img id="fp-up-img" src="" alt="face"/>
          <div class="uc-ph" id="fp-up-ph">
            <i class="fas fa-cloud-upload-alt" style="font-size:34px"></i>
            <span style="font-size:11px;font-family:'Space Mono',monospace">Tap to choose<br>your photo</span>
          </div>
        </div>
        <input type="file" id="fp-file" accept="image/*" capture="user" style="display:none" onchange="fpOnFile(event)"/>
        <div class="f-st" id="fp-up-st">Choose a clear front-facing photo</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn btn-primary" id="fp-up-btn" onclick="fpVerifyUpload()" disabled>
            <i class="fas fa-check-circle"></i> Verify Photo
          </button>
          <button class="btn btn-ghost btn-sm" onclick="fpBack1()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 3: New password -->
    <div id="step3" style="display:none">
      <div style="text-align:center;margin-bottom:16px;color:var(--teal);font-size:13px">
        <i class="fas fa-check-circle"></i> Identity verified! Set your new password.
      </div>
      <div class="form-group">
        <label class="form-label">NEW PASSWORD</label>
        <div style="position:relative">
          <i class="fas fa-lock" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)"></i>
          <input type="password" id="fp-newpw" class="form-control" style="padding-left:40px" placeholder="At least 6 characters"/>
          <button type="button" onclick="toggleFpPw('fp-newpw','eye1')" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer">
            <i class="fas fa-eye" id="eye1"></i>
          </button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">CONFIRM PASSWORD</label>
        <div style="position:relative">
          <i class="fas fa-lock" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)"></i>
          <input type="password" id="fp-confirmpw" class="form-control" style="padding-left:40px" placeholder="Repeat new password"/>
          <button type="button" onclick="toggleFpPw('fp-confirmpw','eye2')" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer">
            <i class="fas fa-eye" id="eye2"></i>
          </button>
        </div>
      </div>
      <button class="btn btn-primary btn-full btn-lg" onclick="doReset()">
        <i class="fas fa-check"></i> Save New Password
      </button>
    </div>

    <!-- STEP 4: Done -->
    <div id="step4" style="display:none;text-align:center;padding:10px 0">
      <div style="font-size:60px;margin-bottom:14px">üéâ</div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:20px;margin-bottom:6px">Password Changed!</div>
      <div style="color:var(--text2);font-size:13px;margin-bottom:22px">Login with your new password now.</div>
      <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg">
        <i class="fas fa-right-to-bracket"></i> Go to Login
      </a>
    </div>
  </div>
</div>

<script>
var fpPin='', fpToken='', fpStream=null, fpModels=false;

function verifyPin(){
  fpPin=document.getElementById('fp-pin').value.trim();
  if(!fpPin){showToast('Enter your PIN','error');return;}
  fetch('/api/forgot/send-otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin:fpPin})})
  .then(function(r){return r.json()})
  .then(function(d){
    if(!d.success){showToast(d.message,'error');return;}
    document.getElementById('step1').style.display='none';
    document.getElementById('step2').style.display='block';
    document.getElementById('slbl-1').className='step-item done';
    document.getElementById('slbl-2').className='step-item active';
    if(!fpModels) loadFpModels();
    fpSwitch('camera');
  });
}

function fpBack1(){
  fpStopCam();
  document.getElementById('step2').style.display='none';
  document.getElementById('step1').style.display='block';
  document.getElementById('slbl-1').className='step-item active';
  document.getElementById('slbl-2').className='step-item';
}

function fpSwitch(mode){
  var isCam=mode==='camera';
  document.getElementById('fp-btn-cam').classList.toggle('active',isCam);
  document.getElementById('fp-btn-up').classList.toggle('active',!isCam);
  document.getElementById('fp-cam-view').style.display=isCam?'block':'none';
  document.getElementById('fp-up-view').style.display=isCam?'none':'block';
  if(isCam)fpStartCam(); else fpStopCam();
}

async function loadFpModels(){
  fpSt('cam','Loading AI models...');fpSt('up','Loading AI models...');
  try{
    var U='/static/weights';
    await faceapi.nets.tinyFaceDetector.loadFromUri(U);
    await faceapi.nets.faceLandmark68TinyNet.loadFromUri(U);
    await faceapi.nets.faceRecognitionNet.loadFromUri(U);
    fpModels=true;
    fpSt('cam','Ready ‚Äî click Verify Face');fpSt('up','Models ready ‚Äî select photo');
    document.getElementById('fp-scan-btn').disabled=false;
    document.getElementById('fp-face-ring').classList.add('scanning');
  }catch(e){fpSt('cam','Model load failed');fpSt('up','Model load failed');}
}

function fpStartCam(){
  if(fpStream)return;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:640}}})
  .then(function(s){fpStream=s;document.getElementById('fp-video').srcObject=s;if(fpModels){document.getElementById('fp-scan-btn').disabled=false;fpSt('cam','Ready ‚Äî click Verify Face');}})
  .catch(function(){fpSt('cam','Camera blocked ‚Äî use Upload Photo');setTimeout(function(){fpSwitch('upload');},1200);});
}
function fpStopCam(){if(fpStream){fpStream.getTracks().forEach(function(t){t.stop()});fpStream=null;}}

async function fpScan(){
  if(!fpModels){fpSt('cam','Still loading...');return;}
  var btn=document.getElementById('fp-scan-btn');
  btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Scanning...';
  fpSt('cam','Detecting face...');
  var video=document.getElementById('fp-video');
  var canvas=document.getElementById('fp-canvas');
  canvas.width=video.videoWidth||320;canvas.height=video.videoHeight||320;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  await fpDoVerify(canvas,'cam',btn,'<i class="fas fa-camera"></i> Verify Face');
}

function fpOnFile(evt){
  var file=evt.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    var img=document.getElementById('fp-up-img');
    img.onload=function(){
      img.style.display='block';
      document.getElementById('fp-up-ph').style.display='none';
      document.getElementById('fp-up-zone').className='upload-circle ready';
      fpSt('up','Photo loaded ‚Äî click Verify Photo');
      document.getElementById('fp-up-btn').disabled=false;
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

async function fpVerifyUpload(){
  if(!fpModels){fpSt('up','Still loading...');return;}
  var btn=document.getElementById('fp-up-btn');
  btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...';
  fpSt('up','Detecting face in photo...');
  var img=document.getElementById('fp-up-img');
  var canvas=document.getElementById('fp-canvas');
  canvas.width=img.naturalWidth||400;canvas.height=img.naturalHeight||400;
  canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
  await fpDoVerify(canvas,'up',btn,'<i class="fas fa-check-circle"></i> Verify Photo');
}

async function fpDoVerify(canvas,mode,btn,resetLabel){
  try{
    var det=await faceapi.detectSingleFace(canvas,new faceapi.TinyFaceDetectorOptions({scoreThreshold:0.3}))
      .withFaceLandmarks(true).withFaceDescriptor();
    if(!det){
      fpApply(mode,false);fpSt(mode,'‚ùå No face found ‚Äî try better lighting or a clearer photo');
      setTimeout(function(){fpApply(mode,null);btn.disabled=false;btn.innerHTML=resetLabel;},2000);return;
    }
    fpSt(mode,'Verifying identity...');
    fetch('/api/forgot/verify-face',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({pin:fpPin,descriptor:Array.from(det.descriptor)})})
    .then(function(r){return r.json()})
    .then(function(d){
      if(d.success){
        fpToken=d.token;fpApply(mode,true);fpSt(mode,'‚úì Identity verified!');
        fpStopCam();
        setTimeout(function(){
          document.getElementById('step2').style.display='none';
          document.getElementById('step3').style.display='block';
          document.getElementById('slbl-2').className='step-item done';
          document.getElementById('slbl-3').className='step-item active';
        },800);
      }else{
        fpApply(mode,false);fpSt(mode,d.message||'Face mismatch');showToast(d.message,'error');
        setTimeout(function(){fpApply(mode,null);btn.disabled=false;btn.innerHTML=resetLabel;},2000);
      }
    });
  }catch(e){fpSt(mode,'Error ‚Äî try again');setTimeout(function(){btn.disabled=false;btn.innerHTML=resetLabel;},1500);}
}

function fpApply(mode,ok){
  if(mode==='cam'){
    if(ok===null){document.getElementById('fp-face-ring').className='face-ring scanning';return;}
    document.getElementById('fp-face-ring').className='face-ring '+(ok?'ok':'fail');
    var o=document.getElementById('fp-overlay');
    o.textContent=ok?'‚úì':'‚úó';o.classList.add('show');setTimeout(function(){o.classList.remove('show');},1500);
  }else{
    if(ok===null){document.getElementById('fp-up-zone').className='upload-circle ready';return;}
    document.getElementById('fp-up-zone').className='upload-circle '+(ok?'ok':'fail');
  }
}

function doReset(){
  var pw=document.getElementById('fp-newpw').value;
  var cpw=document.getElementById('fp-confirmpw').value;
  if(!pw||!cpw){showToast('Fill both fields','error');return;}
  if(pw!==cpw){showToast('Passwords do not match','error');return;}
  if(pw.length<6){showToast('Minimum 6 characters','error');return;}
  fetch('/api/forgot/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pin:fpPin,token:fpToken,password:pw})})
  .then(function(r){return r.json()})
  .then(function(d){
    if(d.success){
      document.getElementById('step3').style.display='none';
      document.getElementById('step4').style.display='block';
      document.getElementById('slbl-3').className='step-item done';
    }else showToast(d.message,'error');
  });
}

function toggleFpPw(id,eyeId){
  var i=document.getElementById(id);i.type=i.type==='password'?'text':'password';
  document.getElementById(eyeId).className=i.type==='password'?'fas fa-eye':'fas fa-eye-slash';
}
function fpSt(mode,msg){document.getElementById(mode==='cam'?'fp-cam-st':'fp-up-st').textContent=msg;}
</script>
{% endblock %}
