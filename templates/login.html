{% extends "base.html" %}
{% block title %}Sign In ‚Äî Smart Attendance System{% endblock %}

{% block auth_content %}
<style>
.login-wrap{min-height:100vh;display:flex;overflow:hidden}
.login-left{flex:1;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;position:relative;overflow:hidden}
.login-left::before{content:'';position:absolute;width:600px;height:600px;background:radial-gradient(ellipse,rgba(108,99,255,0.12) 0%,transparent 70%);top:-200px;left:-200px;pointer-events:none}
.hero-logo{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:4px;background:linear-gradient(135deg,var(--accent-h) 0%,var(--teal) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.1;margin-bottom:8px;position:relative;z-index:1}
.hero-tagline{font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);letter-spacing:4px;margin-bottom:48px;position:relative;z-index:1}
.feature-list{display:flex;flex-direction:column;gap:14px;position:relative;z-index:1;width:100%;max-width:340px}
.feature-item{display:flex;align-items:center;gap:14px;padding:14px 18px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-md);transition:all 0.25s}
.feature-item:hover{border-color:var(--border3);transform:translateX(4px)}
.feature-icon{width:36px;height:36px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.feature-text strong{display:block;font-family:'Syne',sans-serif;font-weight:600;font-size:13px;margin-bottom:2px}
.feature-text span{font-size:12px;color:var(--text2)}
.login-right{width:500px;flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:40px}
.login-box{width:100%;max-width:420px;animation:slideUp 0.5s cubic-bezier(0.4,0,0.2,1) both}
.login-title{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;margin-bottom:6px}
.login-sub{color:var(--text2);font-size:14px;margin-bottom:24px}
.tab-row{display:grid;grid-template-columns:1fr 1fr 1fr;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-md);padding:4px;gap:4px;margin-bottom:22px}
.tab-btn{padding:9px 4px;border:none;background:none;border-radius:var(--r-sm);color:var(--text2);font-family:'Syne',sans-serif;font-weight:600;font-size:12px;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;justify-content:center;gap:6px}
.tab-btn.active{background:var(--accent);color:white;box-shadow:0 4px 12px rgba(108,99,255,0.35)}
.input-icon-wrap{position:relative}
.input-icon-wrap .fas{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px}
.input-icon-wrap .form-control{padding-left:40px}
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:48px 48px;opacity:0.2;pointer-events:none;mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black 20%,transparent 80%)}
#face-step{display:none;text-align:center}
.face-ring{position:relative;width:210px;height:210px;margin:0 auto 10px;border-radius:50%;background:#000;overflow:hidden;border:3px solid var(--border2);transition:border-color 0.3s,box-shadow 0.3s}
.face-ring.scanning{border-color:var(--accent);animation:facePulse 1.5s ease-in-out infinite}
.face-ring.liveness{border-color:var(--amber);animation:livenessP 1s ease-in-out infinite}
.face-ring.ok{border-color:var(--teal);box-shadow:0 0 0 8px rgba(0,212,170,0.15)}
.face-ring.fail{border-color:var(--red);box-shadow:0 0 0 8px rgba(255,107,107,0.15)}
@keyframes facePulse{0%,100%{box-shadow:0 0 0 0 rgba(108,99,255,0.5)}50%{box-shadow:0 0 0 14px rgba(108,99,255,0)}}
@keyframes livenessP{0%,100%{box-shadow:0 0 0 0 rgba(255,193,7,0.5)}50%{box-shadow:0 0 0 12px rgba(255,193,7,0)}}
#face-video{width:100%;height:100%;object-fit:cover;display:block;transform:scaleX(-1)}
.face-overlay{position:absolute;inset:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;opacity:0;transition:opacity 0.3s;background:rgba(0,0,0,0.4)}
.face-overlay.show{opacity:1}
.f-status{font-family:'Space Mono',monospace;font-size:11px;color:var(--text2);margin-bottom:12px;min-height:36px;text-align:center;line-height:1.6}
.liveness-bar{background:var(--bg3);border:1px solid var(--border);border-radius:20px;height:8px;overflow:hidden;margin:4px 0 8px}
.liveness-fill{height:100%;background:linear-gradient(90deg,var(--amber),var(--teal));border-radius:20px;transition:width 0.3s}
@media(max-width:768px){.login-left{display:none}.login-right{width:100%;padding:24px}}
</style>

<script>
(function(){
  var s=document.createElement("script");
  s.src="/static/face-api.min.js";
  s.onerror=function(){var fb=document.createElement("script");fb.src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js";document.head.appendChild(fb);};
  document.head.appendChild(s);
})();
</script>

<div class="grid-bg"></div>
<div class="login-wrap">

  <div class="login-left">
    <div class="hero-logo">Smart<br>Attendance</div>
    <div class="hero-tagline">SMART ATTENDANCE MANAGEMENT SYSTEM</div>
    <div class="feature-list">
      <div class="feature-item">
        <div class="feature-icon" style="background:rgba(108,99,255,0.15);color:var(--accent-h)"><i class="fas fa-camera"></i></div>
        <div class="feature-text"><strong>Live Camera Scan</strong><span>Real-time face recognition only</span></div>
      </div>
      <div class="feature-item">
        <div class="feature-icon" style="background:rgba(255,193,7,0.15);color:var(--amber)"><i class="fas fa-eye"></i></div>
        <div class="feature-text"><strong>Liveness Detection</strong><span>Blink or move ‚Äî no photo spoofing</span></div>
      </div>
      <div class="feature-item">
        <div class="feature-icon" style="background:rgba(0,212,170,0.15);color:var(--teal)"><i class="fas fa-qrcode"></i></div>
        <div class="feature-text"><strong>Dynamic QR Scanning</strong><span>Token refreshes every 15 seconds</span></div>
      </div>
      <div class="feature-item">
        <div class="feature-icon" style="background:rgba(255,107,107,0.15);color:var(--red)"><i class="fas fa-shield-halved"></i></div>
        <div class="feature-text"><strong>Zero Proxy Attendance</strong><span>Your face is your ID</span></div>
      </div>
    </div>
  </div>

  <div class="login-right">
    <div class="login-box">
      <div class="login-title">Welcome back üëã</div>
      <div class="login-sub">Sign in to continue to your dashboard</div>

      <div class="tab-row">
        <button class="tab-btn" onclick="setRole('admin',this)"><i class="fas fa-user-shield"></i> Admin</button>
        <button class="tab-btn" onclick="setRole('lecturer',this)"><i class="fas fa-chalkboard-teacher"></i> Lecturer</button>
        <button class="tab-btn active" onclick="setRole('student',this)"><i class="fas fa-graduation-cap"></i> Student</button>
      </div>

      <!-- STEP 1: Credentials -->
      <div id="pw-step">
        <div class="form-group">
          <label class="form-label">PIN / ID</label>
          <div class="input-icon-wrap">
            <i class="fas fa-id-badge"></i>
            <input type="text" id="pin-input" class="form-control" placeholder="Enter your PIN"/>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">PASSWORD</label>
          <div class="input-icon-wrap">
            <i class="fas fa-lock"></i>
            <input type="password" id="pw-input" class="form-control" placeholder="Enter password"
                   onkeydown="if(event.key==='Enter')handleContinue()"/>
            <button type="button" onclick="togglePw()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer">
              <i class="fas fa-eye" id="eye-icon"></i>
            </button>
          </div>
        </div>
        <button class="btn btn-primary btn-full btn-lg" id="continue-btn" onclick="handleContinue()">
          <i class="fas fa-right-to-bracket"></i> Continue
        </button>
        <div style="text-align:center;margin-top:14px;font-size:13px">
          <a href="{{ url_for('forgot_password') }}" style="color:var(--text3);text-decoration:none">
            <i class="fas fa-key"></i> Forgot Password?
          </a>
        </div>
        <div style="text-align:center;margin-top:10px;font-size:13px;color:var(--text2)">
          New student? <a href="{{ url_for('register') }}" style="color:var(--accent-h);text-decoration:none;font-weight:600">Register here</a>
        </div>
      </div>

      <!-- STEP 2: Face Scan ‚Äî CAMERA ONLY (no upload on login) -->
      <div id="face-step">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:2px">
          <i class="fas fa-face-viewfinder" style="color:var(--accent)"></i> Face Verification
        </div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:12px;font-family:'Space Mono',monospace">
          CAMERA SCAN ¬∑ ONLY YOUR FACE IS CHECKED ¬∑ 75% MATCH NEEDED
        </div>

        <div class="face-ring" id="face-ring">
          <video id="face-video" autoplay muted playsinline></video>
          <div class="face-overlay" id="face-overlay"></div>
        </div>

        <!-- Liveness progress bar (shown after face match) -->
        <div id="liveness-section" style="display:none;margin:0 auto 4px;width:210px;text-align:left">
          <div style="font-size:10px;color:var(--amber);font-family:'Space Mono',monospace;margin-bottom:2px">
            <i class="fas fa-eye"></i> LIVENESS CHECK
          </div>
          <div class="liveness-bar"><div class="liveness-fill" id="liveness-fill" style="width:0%"></div></div>
          <div style="font-size:10px;color:var(--text3);font-family:'Space Mono',monospace" id="liveness-hint">Blink or turn your head</div>
        </div>

        <div class="f-status" id="cam-status">Starting camera...</div>

        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn btn-primary" id="scan-btn" onclick="scanFace()" disabled>
            <i class="fas fa-camera"></i> Scan Face
          </button>
          <button class="btn btn-ghost btn-sm" onclick="backToPw()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<canvas id="face-canvas" style="display:none"></canvas>
<form method="POST" action="{{ url_for('login') }}" id="real-form" style="display:none">
  <input type="hidden" name="pin" id="f-pin"/>
  <input type="hidden" name="password" id="f-pw"/>
</form>

<script>
var currentRole='student', pendingPin='', pendingPw='';
var faceStream=null, modelsLoaded=false;
var livenessOk=false, livenessScore=0, blinkCount=0;
var prevEyeOpen=true, lastNoseX=null, lastNoseY=null;
var livenessInterval=null, faceMatchedDescriptor=null;

function setRole(r,btn){currentRole=r;document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');}
function togglePw(){var i=document.getElementById('pw-input');i.type=i.type==='password'?'text':'password';document.getElementById('eye-icon').className=i.type==='password'?'fas fa-eye':'fas fa-eye-slash';}

function handleContinue(){
  pendingPin=document.getElementById('pin-input').value.trim();
  pendingPw=document.getElementById('pw-input').value;
  if(!pendingPin||!pendingPw){showToast('Enter PIN and password','error');return;}
  var btn=document.getElementById('continue-btn');
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Checking...';btn.disabled=true;
  fetch('/api/check_credentials',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin:pendingPin,password:pendingPw})})
  .then(function(r){return r.json()})
  .then(function(d){
    btn.innerHTML='<i class="fas fa-right-to-bracket"></i> Continue';btn.disabled=false;
    if(!d.success){showToast(d.message||'Invalid credentials','error');return;}
    if(d.skip_face||d.role==='admin'){submitLogin();return;}
    showFaceStep();
  })
  .catch(function(){btn.innerHTML='<i class="fas fa-right-to-bracket"></i> Continue';btn.disabled=false;showToast('Network error','error');});
}

function showFaceStep(){
  document.getElementById('pw-step').style.display='none';
  document.getElementById('face-step').style.display='block';
  resetLiveness();
  if(!modelsLoaded) loadModels();
  else startCamera();
}
function backToPw(){
  stopCamera();
  document.getElementById('face-step').style.display='none';
  document.getElementById('pw-step').style.display='block';
}

async function loadModels(){
  setSt('Loading AI models... (first time may take ~10s)');
  try{
    var U='/static/weights';
    await faceapi.nets.tinyFaceDetector.loadFromUri(U);
    await faceapi.nets.faceLandmark68TinyNet.loadFromUri(U);
    await faceapi.nets.faceRecognitionNet.loadFromUri(U);
    modelsLoaded=true;
    setSt('Ready ‚Äî click Scan Face');
    document.getElementById('scan-btn').disabled=false;
    startCamera();
  }catch(e){setSt('‚ùå Failed to load models. Check internet.');}
}

function startCamera(){
  if(faceStream) return;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}})
  .then(function(s){
    faceStream=s;
    document.getElementById('face-video').srcObject=s;
    document.getElementById('face-ring').classList.add('scanning');
    if(modelsLoaded){document.getElementById('scan-btn').disabled=false;setSt('Ready ‚Äî click Scan Face');}
    else setSt('Loading models...');
  })
  .catch(function(){setSt('‚ùå Camera blocked. Please allow camera access and try again.');});
}
function stopCamera(){
  if(faceStream){faceStream.getTracks().forEach(function(t){t.stop()});faceStream=null;}
  clearInterval(livenessInterval);livenessInterval=null;
}

// ‚îÄ‚îÄ Liveness ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dist2d(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2));}
function eyeAR(pts,idx){
  var A=dist2d(pts[idx[1]],pts[idx[5]]),B=dist2d(pts[idx[2]],pts[idx[4]]),C=dist2d(pts[idx[0]],pts[idx[3]]);
  return (A+B)/(2.0*C);
}
function checkLiveness(det){
  if(!det||!det.landmarks) return;
  var pts=det.landmarks.positions;
  if(!pts||pts.length<68) return;
  var nose=pts[30];
  if(lastNoseX!==null){
    var dx=Math.abs(nose.x-lastNoseX),dy=Math.abs(nose.y-lastNoseY);
    if(dx>5||dy>4){livenessScore=Math.min(100,livenessScore+10);}
  }
  lastNoseX=nose.x;lastNoseY=nose.y;
  var lEAR=eyeAR(pts,[36,37,38,39,40,41]);
  var rEAR=eyeAR(pts,[42,43,44,45,46,47]);
  var ear=(lEAR+rEAR)/2;
  var blinking=ear<0.22;
  if(!blinking&&!prevEyeOpen){blinkCount++;livenessScore=Math.min(100,livenessScore+30);}
  prevEyeOpen=!blinking;
  document.getElementById('liveness-fill').style.width=livenessScore+'%';
  if(livenessScore>=75&&!livenessOk){
    livenessOk=true;
    document.getElementById('liveness-hint').textContent='‚úì Confirmed!';
    if(faceMatchedDescriptor) sendVerifyWithLiveness(faceMatchedDescriptor);
  } else if(!livenessOk){
    document.getElementById('liveness-hint').textContent=blinkCount>0?('Blink detected ‚Äî keep moving ('+blinkCount+')'):'Blink or turn your head';
  }
}

function resetLiveness(){
  livenessOk=false;livenessScore=0;blinkCount=0;lastNoseX=null;lastNoseY=null;prevEyeOpen=true;faceMatchedDescriptor=null;
  clearInterval(livenessInterval);livenessInterval=null;
  document.getElementById('liveness-section').style.display='none';
  document.getElementById('liveness-fill').style.width='0%';
}

// ‚îÄ‚îÄ Scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function scanFace(){
  if(!modelsLoaded){setSt('Still loading models...');return;}
  if(!faceStream){startCamera();setSt('Starting camera...');return;}
  var btn=document.getElementById('scan-btn');
  btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Scanning...';
  setSt('Detecting your face...');
  var video=document.getElementById('face-video');
  var canvas=document.getElementById('face-canvas');
  canvas.width=video.videoWidth||320;canvas.height=video.videoHeight||320;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  try{
    var det=await faceapi.detectSingleFace(canvas,new faceapi.TinyFaceDetectorOptions({scoreThreshold:0.35}))
      .withFaceLandmarks(true).withFaceDescriptor();
    if(!det){
      applyResult(false);setSt('‚ùå No face detected.\nFace the camera directly with good lighting.');
      setTimeout(resetScanBtn,2500);return;
    }
    setSt('Face found ‚Äî verifying with server...');
    var descriptor=Array.from(det.descriptor);
    fetch('/api/verify_face_image',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({pin:pendingPin,descriptor:descriptor,liveness_ok:false})})
    .then(function(r){return r.json()})
    .then(function(d){
      if(d.liveness_required){
        // Face matched at 75%+ ‚Äî now need liveness
        faceMatchedDescriptor=descriptor;
        setSt('‚úì Face matched! Now prove you are live...');
        document.getElementById('face-ring').className='face-ring liveness';
        document.getElementById('liveness-section').style.display='block';
        resetLiveness();faceMatchedDescriptor=descriptor;
        // Start continuous liveness tracking
        livenessInterval=setInterval(async function(){
          if(!faceStream) return;
          var c=document.getElementById('face-canvas');
          var v=document.getElementById('face-video');
          c.width=v.videoWidth||320;c.height=v.videoHeight||320;
          c.getContext('2d').drawImage(v,0,0,c.width,c.height);
          try{
            var ld=await faceapi.detectSingleFace(c,new faceapi.TinyFaceDetectorOptions({scoreThreshold:0.25})).withFaceLandmarks(true);
            checkLiveness(ld);
          }catch(e){}
        },150);
      } else if(d.success){
        applyResult(true);setSt('‚úì Verified! Signing in...');stopCamera();setTimeout(submitLogin,700);
      } else {
        applyResult(false);setSt(d.message||'Face does not match.');showToast(d.message||'Face mismatch','error');
        setTimeout(resetScanBtn,2500);
      }
    })
    .catch(function(){setSt('Network error. Try again.');setTimeout(resetScanBtn,1500);});
  }catch(e){setSt('Error ‚Äî try again.');setTimeout(resetScanBtn,1500);}
}

function sendVerifyWithLiveness(descriptor){
  clearInterval(livenessInterval);livenessInterval=null;
  setSt('‚úì Liveness confirmed! Signing in...');
  applyResult(true);
  fetch('/api/verify_face_image',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pin:pendingPin,descriptor:descriptor,liveness_ok:true})})
  .then(function(r){return r.json()})
  .then(function(d){
    if(d.success){stopCamera();setTimeout(submitLogin,600);}
    else{applyResult(false);setSt(d.message||'Verification failed');showToast(d.message||'Try again','error');setTimeout(resetScanBtn,2000);}
  });
}

function applyResult(ok){
  var ring=document.getElementById('face-ring'),ov=document.getElementById('face-overlay');
  ring.className='face-ring '+(ok?'ok':'fail');
  ov.textContent=ok?'‚úì':'‚úó';ov.classList.add('show');
  setTimeout(function(){ov.classList.remove('show');},1500);
}
function resetScanBtn(){
  resetLiveness();
  document.getElementById('face-ring').className='face-ring scanning';
  var btn=document.getElementById('scan-btn');
  btn.disabled=false;btn.innerHTML='<i class="fas fa-camera"></i> Scan Face';
}
function setSt(msg){document.getElementById('cam-status').textContent=msg;}
function submitLogin(){document.getElementById('f-pin').value=pendingPin;document.getElementById('f-pw').value=pendingPw;document.getElementById('real-form').submit();}
</script>
{% endblock %}
