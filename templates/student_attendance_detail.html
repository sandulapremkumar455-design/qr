{% extends "base.html" %}
{% block title %}{{ student.name }} ‚Äî Attendance Record{% endblock %}
{% block page_title %}
  <a href="{{ url_for('student_info') }}" style="color:var(--text3);text-decoration:none;font-size:13px;margin-right:10px;">
    <i class="fas fa-arrow-left"></i>
  </a>
  {{ student.name }}
{% endblock %}

{% block content %}

<!-- TOP CARDS -->
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-bottom:24px;">

  <div class="stat-card accent">
    <div class="stat-icon accent"><i class="fas fa-calendar-check"></i></div>
    <div class="stat-value" style="color:var(--accent-h)">{{ stats.attended }}</div>
    <div class="stat-label">CLASSES ATTENDED</div>
  </div>

  <div class="stat-card teal">
    <div class="stat-icon teal"><i class="fas fa-chalkboard"></i></div>
    <div class="stat-value" style="color:var(--teal)">{{ stats.total_sessions }}</div>
    <div class="stat-label">TOTAL CLASSES</div>
  </div>

  <div class="stat-card {% if stats.overall_pct >= 75 %}teal{% elif stats.overall_pct >= 60 %}amber{% else %}danger{% endif %}">
    <div class="stat-icon {% if stats.overall_pct >= 75 %}teal{% elif stats.overall_pct >= 60 %}amber{% else %}danger{% endif %}">
      <i class="fas fa-percent"></i>
    </div>
    <div class="stat-value" style="color:{% if stats.overall_pct >= 75 %}var(--teal){% elif stats.overall_pct >= 60 %}var(--amber){% else %}var(--red){% endif %}">
      {{ stats.overall_pct }}%
    </div>
    <div class="stat-label">OVERALL ATTENDANCE</div>
  </div>

  <div class="stat-card {% if stats.warning %}danger{% else %}teal{% endif %}">
    <div class="stat-icon {% if stats.warning %}danger{% else %}teal{% endif %}">
      <i class="fas fa-{% if stats.warning %}triangle-exclamation{% else %}circle-check{% endif %}"></i>
    </div>
    <div class="stat-value" style="font-size:24px;font-family:'Syne',sans-serif;color:{% if stats.warning %}var(--red){% else %}var(--teal){% endif %}">
      {% if stats.warning %}LOW{% else %}OK{% endif %}
    </div>
    <div class="stat-label">STATUS</div>
  </div>
</div>

<!-- STUDENT INFO STRIP -->
<div class="card" style="margin-bottom:20px;">
  <div class="card-body" style="padding:16px 24px;">
    <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
      <div style="width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid var(--border2);flex-shrink:0;background:var(--bg3);">
        {% if student.face_image %}
          <img src="data:image/jpeg;base64,{{ student.face_image }}" style="width:100%;height:100%;object-fit:cover" alt="{{ student.name }}"/>
        {% else %}
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg,var(--accent),var(--teal));
            font-family:'Syne',sans-serif;font-weight:700;font-size:20px;color:#fff;">
            {{ student.name[0].upper() }}
          </div>
        {% endif %}
      </div>
      <div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">{{ student.name }}</div>
        <div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);margin-top:3px;">
          PIN: {{ student.pin }} &nbsp;¬∑&nbsp; {{ student.year }} &nbsp;¬∑&nbsp; {{ student.branch }}
          &nbsp;¬∑&nbsp; {% if student.is_suspended %}<span style="color:var(--red)">SUSPENDED</span>{% else %}<span style="color:var(--teal)">ACTIVE</span>{% endif %}
        </div>
        {% if student.last_login %}
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);margin-top:3px;">
          Last login: {{ student.last_login.strftime('%d %b %Y, %I:%M %p') }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- SUBJECT BREAKDOWN -->
{% if stats.breakdown %}
<div class="card" style="margin-bottom:20px;">
  <div class="card-header">
    <div class="card-title"><i class="fas fa-book-open" style="color:var(--accent);margin-right:8px;"></i>Subject-wise Breakdown</div>
  </div>
  <div class="card-body" style="padding:0;">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>SUBJECT</th>
            <th>CONDUCTED</th>
            <th>ATTENDED</th>
            <th>PERCENTAGE</th>
          </tr>
        </thead>
        <tbody>
          {% for b in stats.breakdown %}
          <tr>
            <td style="font-family:'Syne',sans-serif;font-weight:600;text-transform:capitalize;">
              {{ b.subject }}
              {% if b.warning %}<span class="badge badge-danger" style="margin-left:6px;">LOW</span>{% endif %}
            </td>
            <td style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--text2);">{{ b.conducted }}</td>
            <td style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--teal);">{{ b.attended }}</td>
            <td style="min-width:150px;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-family:'Syne',sans-serif;font-weight:700;min-width:40px;color:
                  {% if b.percentage >= 75 %}var(--teal){% elif b.percentage >= 60 %}var(--amber){% else %}var(--red){% endif %}">
                  {{ b.percentage }}%
                </span>
                <div class="progress-bar" style="flex:1;">
                  <div class="progress-fill {{ 'good' if b.percentage >= 75 else ('warning' if b.percentage >= 60 else 'danger') }}"
                       data-pct="{{ b.percentage }}" style="width:0%"></div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- FULL ATTENDANCE HISTORY -->
<div class="card">
  <div class="card-header">
    <div class="card-title"><i class="fas fa-list-check" style="color:var(--teal);margin-right:8px;"></i>Attendance History</div>
    <span class="badge badge-teal">{{ history|length }} records</span>
  </div>
  <div class="card-body" style="padding:0;">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>SUBJECT</th>
            <th>DATE & TIME</th>
            <th>BATCH</th>
            <th>METHOD</th>
          </tr>
        </thead>
        <tbody>
          {% for att, sess, subj in history %}
          <tr>
            <td class="text-muted font-mono text-xs">{{ loop.index }}</td>
            <td style="font-family:'Syne',sans-serif;font-weight:600;text-transform:capitalize;">{{ subj.name }}</td>
            <td class="font-mono text-xs text-muted">{{ att.timestamp.strftime('%d %b %Y, %I:%M %p') }}</td>
            <td class="text-sm text-muted">{{ sess.year }} ¬∑ {{ sess.branch }}</td>
            <td>
              {% if att.is_manual %}
                <span class="badge badge-amber">‚úèÔ∏è Manual</span>
              {% else %}
                <span class="badge badge-teal">üì± QR Scan</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5">
              <div class="empty-state"><i class="fas fa-calendar-xmark"></i><p>No attendance records found.</p></div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.progress-fill[data-pct]').forEach(function(el){
  setTimeout(function(){el.style.width=el.dataset.pct+'%'},100);
});
</script>

{% endblock %}
